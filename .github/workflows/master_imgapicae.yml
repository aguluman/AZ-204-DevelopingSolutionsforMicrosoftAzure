name: '$(Date:yyyyMMdd)$(Rev:.rr)'

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  - job: build_markdown_content
    displayName: 'Build Markdown Content'
    workspace:
      clean: all
    pool:
      vmImage: 'ubuntu-latest'
    container:
      image: 'microsoftlearning/markdown-build:latest'
    steps:
      - task: Bash@3
        displayName: 'Build Content'
        inputs:
          targetType: inline
          script: |
            cp /{attribution.md,template.docx,package.json,package.js} .
            npm install
            node package.js --version $(Build.BuildNumber)
      - task: GitHubRelease@0
        displayName: 'Create GitHub Release'
        inputs:
          gitHubConnection: 'github-microsoftlearning-organization'
          repositoryName: '$(Build.Repository.Name)'
          tagSource: manual
          tag: 'v$(Build.BuildNumber)'
          title: 'Version $(Build.BuildNumber)'
          releaseNotesSource: input
          releaseNotes: '# Version $(Build.BuildNumber) Release'
          assets: '$(Build.SourcesDirectory)/out/*.zip'
          assetUploadMode: replace
          isPreRelease: false
      - task: PublishBuildArtifacts@1
        displayName: 'Publish Output Files'
        inputs:
          pathtoPublish: '$(Build.SourcesDirectory)/out/'
          artifactName: 'Lab Files'

  - job: build_dotnet_project
    displayName: 'Build .NET Project'
    pool:
      vmImage: 'windows-latest'
    steps:
      - task: UseDotNet@2
        inputs:
          packageType: 'sdk'
          version: '6.x'
          installationPath: $(Agent.ToolsDirectory)/dotnet

      - uses: actions/checkout@v2

      - script: |
          cd AZ-204-DevelopingSolutionsforMicrosoftAzure\Allfiles\Labs\01\Starter\API
          dotnet build API.sln --configuration Release
        displayName: 'Build .NET Solution'